<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Plan+ Ultimate Cloud</title>
    <style>
        :root { --primary: #1a73e8; --success: #34a853; --danger: #ea4335; --warning: #fbbc04; --bg: #f8f9fa; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; }
        .page { display: none; padding: 20px; animation: fadeIn 0.2s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: white; padding: 18px; border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        h1 { font-size: 22px; color: var(--primary); margin-bottom: 15px; }
        h2 { font-size: 16px; margin: 0 0 10px 0; border-left: 4px solid var(--primary); padding-left: 10px; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 100; }
        .nav-item { flex: 1; text-align: center; padding: 10px 0; font-size: 12px; color: #666; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        input, select, button { width: 100%; padding: 12px; margin: 5px 0 10px 0; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-danger { background: var(--danger); }
        .btn-sm { padding: 6px; font-size: 12px; background: #e8f0fe; color: var(--primary); border: 1px solid var(--primary); border-radius: 8px; cursor: pointer; }
        .budget-row { margin-bottom: 12px; }
        .budget-label { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; }
        .progress-bg { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s; }
        .debt-banner { background: #e8f0fe; padding: 12px; border-radius: 12px; text-align: center; color: var(--primary); font-weight: bold; margin-bottom: 15px; }
        .log-item { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; display: flex; justify-content: space-between; align-items: flex-start; flex-direction: column; }
        .log-actions { margin-top: 8px; display: flex; gap: 10px; width: 100%; justify-content: flex-end; }
        #sync-status { font-size: 10px; color: #999; text-align: center; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="page-home" class="page active">
        <div id="sync-status">é›²ç«¯åŒæ­¥ä¸­...</div>
        <h1>ğŸ  æ¦‚è¦½</h1>
        <div class="debt-banner" id="home-debt">âœ¨ è¨ˆç®—ä¸­...</div>
        <div class="card">
            <h2>ğŸ“Š é ç®—é€²åº¦</h2>
            <div id="home-budgets"></div>
        </div>
        <div class="card">
            <h2>ğŸ“œ æœ€è¿‘ç´€éŒ„</h2>
            <div id="home-logs"></div>
        </div>
    </div>

    <div id="page-expense" class="page">
        <h1>ğŸ’¸ æ”¯å‡ºè¨˜å¸³</h1>
        <div class="card">
            <input type="text" id="exp-item" placeholder="è²·äº†ä»€éº¼ï¼Ÿ">
            <input type="number" id="exp-total" placeholder="ç¸½é‡‘é¡" oninput="autoSplit()">
            <select id="exp-cat"></select>
            <label>ğŸ’° èª°ç¾å ´ä»˜éŒ¢ï¼Ÿ</label>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button class="btn-sm" onclick="quickPay('83')">83å…¨ä»˜</button>
                <button class="btn-sm" onclick="quickPay('jy')">æ·åª–å…¨ä»˜</button>
            </div>
            <div style="display:flex; gap:10px">
                <input type="number" id="p-83" placeholder="83ä»˜">
                <input type="number" id="p-jy" placeholder="æ·åª–ä»˜">
            </div>
            <label>ğŸ¤ èª°è©²è² æ“”ï¼Ÿ</label>
            <div style="display:flex; gap:5px; margin-bottom:10px;"><button class="btn-sm" onclick="autoSplit()">å…©äººå¹³åˆ†</button></div>
            <div style="display:flex; gap:10px">
                <input type="number" id="o-83" placeholder="83æ“”">
                <input type="number" id="o-jy" placeholder="æ·åª–æ“”">
            </div>
            <button onclick="saveExpense()">ç¢ºèªå­˜æª”</button>
        </div>
    </div>

    <div id="page-income" class="page">
        <h1>ğŸ’° æ–°å¢æ”¶å…¥</h1>
        <div class="card">
            <input type="text" id="inc-item" placeholder="è–ªæ°´/çé‡‘é …ç›®">
            <input type="number" id="inc-amt" placeholder="é‡‘é¡">
            <select id="inc-cat"></select>
            <button onclick="saveIncome()" style="background:var(--success)">ç¢ºèªå…¥å¸³</button>
        </div>
    </div>

    <div id="page-manage" class="page">
        <h1>âš™ï¸ ç®¡ç†é ç®—</h1>
        <div class="card">
            <h2>ğŸ†• æ–°å¢/ç·¨è¼¯åˆ†é¡</h2>
            <input type="text" id="m-name" placeholder="åˆ†é¡åç¨±">
            <input type="number" id="m-amt" placeholder="æ¯æœˆç›®æ¨™é ç®—">
            <button onclick="saveCategory()">å„²å­˜åˆ†é¡</button>
        </div>
        <div id="manage-list"></div>
        <button class="btn-danger" onclick="resetData()" style="margin-top:20px">âš ï¸ æ¸…é™¤æ‰€æœ‰èˆŠè³‡æ–™ä¸¦ä¿®å¾©</button>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="showPage('home')">ğŸ é¦–é </div>
        <div class="nav-item" onclick="showPage('expense')">ğŸ’¸æ”¯å‡º</div>
        <div class="nav-item" onclick="showPage('income')">ğŸ’°æ”¶å…¥</div>
        <div class="nav-item" onclick="showPage('manage')">âš™ï¸ç®¡ç†</div>
    </div>

    <script>
        // --- 1. è¨­å®šèˆ‡åˆå§‹åŒ– ---
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzoqvaeVa8uM0IFwiSwNJJfioFYsnQ5ArELO8GHiIyPyDwMA9edNGTUF508KSXfMNu9gw/exec";

        let state = {
            budgets: { "é¤è²»": { total: 10000, remain: 10000 }, "è²¸æ¬¾": { total: 15000, remain: 15000 } },
            netDebt: 0,
            logs: []
        };

        // å¾æœ¬åœ°è®€å–ç·©å­˜
        const rawData = localStorage.getItem('moneyPlanData');
        if (rawData) {
            try {
                let parsed = JSON.parse(rawData);
                state.logs = (parsed.logs || []).filter(l => typeof l === 'object' && l !== null && l.txt);
                state.budgets = parsed.budgets || state.budgets;
                state.netDebt = parsed.netDebt || 0;
            } catch(e) { console.error("æœ¬åœ°è³‡æ–™æå£"); }
        }

        // --- 2. é›²ç«¯åŒæ­¥é‚è¼¯ ---
        async function syncToCloud() {
            document.getElementById('sync-status').innerText = "â˜ï¸ æ­£åœ¨åŒæ­¥è‡³é›²ç«¯...";
            try {
                await fetch(WEB_APP_URL, {
                    method: "POST",
                    mode: 'no-cors', // è§£æ±ºè·¨åŸŸå•é¡Œ
                    body: JSON.stringify({ action: "save", state: state })
                });
                document.getElementById('sync-status').innerText = "âœ… é›²ç«¯å·²åŒæ­¥";
            } catch (e) {
                document.getElementById('sync-status').innerText = "âŒ åŒæ­¥å¤±æ•— (é›¢ç·šæ¨¡å¼)";
            }
        }

        async function loadFromCloud() {
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "load" })
                });
                const cloudState = await response.json();
                if (cloudState && cloudState.budgets) {
                    state = cloudState;
                    localStorage.setItem('moneyPlanData', JSON.stringify(state));
                    renderAll();
                    document.getElementById('sync-status').innerText = "âœ… å·²ç²å–é›²ç«¯æœ€æ–°è³‡æ–™";
                }
            } catch (e) {
                document.getElementById('sync-status').innerText = "âš ï¸ ç„¡æ³•è®€å–é›²ç«¯ï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™";
            }
        }

        // --- 3. æ ¸å¿ƒåŠŸèƒ½é‚è¼¯ ---
        function save() {
            localStorage.setItem('moneyPlanData', JSON.stringify(state));
            renderAll();
            syncToCloud();
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            window.event.currentTarget.classList.add('active');
            renderAll();
        }

        function autoSplit() {
            const t = parseFloat(document.getElementById('exp-total').value || 0);
            if(t > 0) {
                document.getElementById('o-83').value = (t/2).toFixed(0);
                document.getElementById('o-jy').value = (t/2).toFixed(0);
            }
        }

        function quickPay(who) {
            const t = parseFloat(document.getElementById('exp-total').value || 0);
            document.getElementById('p-83').value = (who === '83' ? t : 0);
            document.getElementById('p-jy').value = (who === 'jy' ? t : 0);
        }

        function renderAll() {
            renderHome();
            const cats = Object.keys(state.budgets).map(n => `<option value="${n}">${n}</option>`).join('');
            document.getElementById('exp-cat').innerHTML = cats;
            document.getElementById('inc-cat').innerHTML = cats;
            renderManageList();
        }

        function renderHome() {
            const d = document.getElementById('home-debt');
            if (state.netDebt > 0) d.innerText = `âš ï¸ æ·åª– æ¬  83 $${Math.round(state.netDebt)}`;
            else if (state.netDebt < 0) d.innerText = `âœ… 83 æ¬  æ·åª– $${Math.round(Math.abs(state.netDebt))}`;
            else d.innerText = `âœ¨ ç›®å‰é›™æ–¹äº’ä¸ç›¸æ¬ `;

            const bCont = document.getElementById('home-budgets');
            bCont.innerHTML = '';
            for (let n in state.budgets) {
                const b = state.budgets[n];
                const p = Math.max(0, (b.remain / b.total * 100).toFixed(0));
                bCont.innerHTML += `<div class="budget-row">
                    <div class="budget-label"><span>${n}</span><span>$${Math.round(b.remain)} / $${b.total}</span></div>
                    <div class="progress-bg"><div class="progress-fill" style="width:${p}%; background:${p < 20 ? '#ea4335' : '#34a853'}"></div></div>
                </div>`;
            }

            document.getElementById('home-logs').innerHTML = state.logs.map((l, idx) => `
                <div class="log-item">
                    <div><b>${l.txt}</b> <small style="color:#999">${l.date || ''}</small></div>
                    <div class="log-actions">
                        <span class="btn-sm" style="color:var(--primary)" onclick="editLog(${idx})">ç·¨è¼¯</span>
                        <span class="btn-sm" style="color:var(--danger)" onclick="deleteLog(${idx})">åˆªé™¤</span>
                    </div>
                </div>`).join('');
        }

        function renderManageList() {
            const m = document.getElementById('manage-list');
            m.innerHTML = '<h2>ç¾æœ‰é ç®—åˆ—è¡¨</h2>';
            for (let n in state.budgets) {
                m.innerHTML += `<div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <span onclick="fillManage('${n}', ${state.budgets[n].total})"><b>${n}</b>: $${state.budgets[n].total}</span>
                    <button onclick="deleteCat('${n}')" style="width:auto; padding:5px; background:var(--danger)">åˆªé™¤</button>
                </div>`;
            }
        }

        function fillManage(n, a) { document.getElementById('m-name').value = n; document.getElementById('m-amt').value = a; }

        function saveExpense() {
            const item = document.getElementById('exp-item').value;
            const total = parseFloat(document.getElementById('exp-total').value || 0);
            const cat = document.getElementById('exp-cat').value;
            const p83 = parseFloat(document.getElementById('p-83').value || 0);
            const pjy = parseFloat(document.getElementById('p-jy').value || 0);
            const o83 = parseFloat(document.getElementById('o-83').value || 0);
            const ojy = parseFloat(document.getElementById('o-jy').value || 0);

            if (!item || total <= 0) return alert("è«‹å¡«å¯«å…§å®¹");
            
            const logEntry = {
                txt: `ğŸ’¸ ${item} -$${total} (${cat})`,
                type: 'exp',
                amount: total,
                category: cat,
                debtChange: (ojy - pjy),
                date: new Date().toLocaleDateString(),
                details: { item, total, cat, p83, pjy, o83, ojy }
            };
            
            state.budgets[cat].remain -= total;
            state.netDebt += logEntry.debtChange;
            state.logs.unshift(logEntry);
            save();
            showPage('home');
        }

        function saveIncome() {
            const item = document.getElementById('inc-item').value;
            const amt = parseFloat(document.getElementById('inc-amt').value || 0);
            const cat = document.getElementById('inc-cat').value;
            if (!item || amt <= 0) return alert("è³‡è¨Šä¸å®Œæ•´");

            const logEntry = {
                txt: `ğŸ’° ${item} +$${amt} (${cat})`,
                type: 'inc',
                amount: amt,
                category: cat,
                date: new Date().toLocaleDateString()
            };

            state.budgets[cat].total += amt;
            state.budgets[cat].remain += amt;
            state.logs.unshift(logEntry);
            save();
            showPage('home');
        }

        function editLog(idx) {
            const l = state.logs[idx];
            if (l.type !== 'exp') return alert("ç›®å‰åƒ…æ”¯æ´æ”¯å‡ºç·¨è¼¯");
            document.getElementById('exp-item').value = l.details.item;
            document.getElementById('exp-total').value = l.details.total;
            document.getElementById('exp-cat').value = l.details.cat;
            document.getElementById('p-83').value = l.details.p83;
            document.getElementById('p-jy').value = l.details.pjy;
            document.getElementById('o-83').value = l.details.o83;
            document.getElementById('o-jy').value = l.details.ojy;
            deleteLog(idx, true);
            showPage('expense');
        }

        function deleteLog(idx, silent = false) {
            if (!silent && !confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
            const l = state.logs[idx];
            if (l.type === 'exp') {
                state.budgets[l.category].remain += l.amount;
                state.netDebt -= l.debtChange;
            } else {
                state.budgets[l.category].total -= l.amount;
                state.budgets[l.category].remain -= l.amount;
            }
            state.logs.splice(idx, 1);
            save();
        }

        function saveCategory() {
            const n = document.getElementById('m-name').value;
            const a = parseFloat(document.getElementById('m-amt').value || 0);
            if (n && a > 0) {
                if (state.budgets[n]) {
                    const diff = a - state.budgets[n].total;
                    state.budgets[n].total = a;
                    state.budgets[n].remain += diff;
                } else { state.budgets[n] = { total: a, remain: a }; }
                save();
            }
        }

        function deleteCat(n) { if (confirm(`ç¢ºå®šåˆªé™¤ ${n}ï¼Ÿ`)) { delete state.budgets[n]; save(); } }

        function resetData() {
            if (confirm("âš ï¸ ç¢ºå®šé‡ç½®ï¼Ÿ")) {
                localStorage.removeItem('moneyPlanData');
                location.reload();
            }
        }

        // å•Ÿå‹•è¼‰å…¥
        renderAll();
        loadFromCloud();
    </script>
</body>
</html>
